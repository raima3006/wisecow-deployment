name: Deploy Wisecow with Kind and TLS

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      # Step 1: Checkout the repo
      - name: Checkout repository
        uses: actions/checkout@v3

      # Step 2: Set up Docker
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v2

      # Step 3: Log in to Docker Hub
      - name: Log in to Docker Hub
        uses: docker/login-action@v2
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # Step 4: Build and push Docker image
      - name: Build and Push Docker image
        run: |
          docker build -t ${{ secrets.DOCKER_USERNAME }}/wisecow:latest .
          docker push ${{ secrets.DOCKER_USERNAME }}/wisecow:latest

      # Step 5: Set up Kind (local Kubernetes cluster in GitHub Actions)
      - name: Set up Kind
        uses: engineerd/setup-kind@v0.6.0
        with:
          version: v0.20.0

      # Step 6: Load Docker image into Kind
      - name: Load Docker image into Kind
        run: kind load docker-image ${{ secrets.DOCKER_USERNAME }}/wisecow:latest

      # Step 7: Apply Kubernetes manifests
      - name: Apply Kubernetes manifests
        run: |
          kubectl apply -f k8s/wisecow-deployment.yaml --validate=false
          kubectl apply -f k8s/wisecow-service.yaml --validate=false

      # Step 8: Create TLS secret
      - name: Create TLS secret
        run: |
          kubectl create secret tls wisecow-tls \
            --cert=k8s/tls/wisecow.crt \
            --key=k8s/tls/wisecow.key \
            --dry-run=client -o yaml | kubectl apply -f -

      # Step 9: Restart deployment to pick up TLS secret
      - name: Restart Wisecow deployment
        run: kubectl rollout restart deployment wisecow-deployment

      # Step 10: Wait for pod to be ready
      - name: Wait for pod readiness
        run: kubectl wait --for=condition=ready pod -l app=wisecow --timeout=120s

      # Step 11: Verify pod logs
      - name: Verify logs
        run: kubectl logs -l app=wisecow
